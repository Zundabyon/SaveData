<%= render 'shared/header' %>
<div class="min-h-screen text-slate-100 flex">

  <!-- 左：ダミー余白 -->
  <aside class="hidden md:block w-72"></aside>

  <!-- 中央：年表 -->
  <main class="flex-1 px-6 py-12 scroll-smooth">

    <header class="mb-16 text-center">
      <h1 class="text-3xl md:text-4xl font-bold tracking-widest">
        ── <%= @user.name %> の冒険の記録 ──
      </h1>
      <p class="mt-2 text-sm text-slate-400">
        セーブデータを選んでください
      </p>
    </header>

    <div class="relative max-w-3xl mx-auto timeline-scan">
      <div class="absolute left-4 top-0 h-full w-px bg-slate-700"></div>

      <% @games.each do |game| %>
        <% next if game.played_year.blank? || game.title.blank? %>

        <div id="year-<%= game.played_year %>" class="relative pl-12 pb-12 scroll-mt-32">

          <!-- 年マーカー -->
          <div class="absolute left-0 top-1 w-8 h-8 rounded-full
                      bg-slate-900 border border-slate-500
                      flex items-center justify-center
                      text-xs font-bold year-marker">
            <%= game.played_age %>歳
          </div>

          <!-- カード -->
          <div
            class="timeline-card bg-slate-800/60 backdrop-blur
                   border border-slate-700 rounded-xl
                   p-5 shadow-lg cursor-pointer
                   hover:border-slate-500 transition"
            onclick="openModal(
              '<%= j game.title %>',
              '<%= j [game.hardware, game.genre, (game.played_age && "#{game.played_age}歳")].compact.join(" / ") %>',
              '<%= j game.memo %>'
            )"
          >

            <h2 class="text-lg font-semibold tracking-wide">
              <%= game.title %>
            </h2>

            <div class="mt-2 flex flex-wrap gap-3 text-xs text-slate-400">
              <% if game.hardware.present? %><span>🎮 <%= game.hardware %></span><% end %>
              <% if game.genre.present? %><span>⚔️ <%= game.genre %></span><% end %>
              <% if game.played_age.present? %><span>🕰 <%= game.played_age %>歳</span><% end %>
            </div>

            <!-- マテリア評価 -->
            <div class="mt-3 space-y-2 text-xs text-slate-300">
              <% if game.difficulty.present? %>
                <div class="flex items-center gap-2">
                  <span class="w-14">難易度</span>
                  <div class="flex gap-1">
                    <% 5.times do |i| %>
                      <span class="materia materia-red <%= 'inactive' if i >= game.difficulty %>"></span>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <% if game.fun.present? %>
                <div class="flex items-center gap-2">
                  <span class="w-14">面白さ</span>
                  <div class="flex gap-1">
                    <% 5.times do |i| %>
                      <span class="materia materia-green <%= 'inactive' if i >= game.fun %>"></span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>

            <% if game.memo.present? %>
              <p class="mt-4 text-sm text-slate-300 leading-relaxed line-clamp-2">
                「<%= game.memo %>」
              </p>
            <% end %>

          </div>
        </div>
      <% end %>
    </div>
  </main>

  <!-- 右：FF7メニュー -->
  <aside class="hidden md:block w-72 relative">
    <div class="sticky top-20 mr-8">
      <div class="bg-[#0b0f2a]/90 backdrop-blur
                  border border-blue-300/40
                  shadow-[0_0_30px_rgba(80,120,255,0.35)]
                  px-8 py-6 space-y-4 ff7-side-window">

        <div class="text-xs tracking-widest text-blue-200 opacity-80 text-center">
          冒険の記録
        </div>

        <% @games.each do |game| %>
          <% next if game.played_age.blank? || game.played_year.blank? %>
          <a href="#year-<%= game.played_year %>"
             data-year="<%= game.played_year %>"
             class="ff7-age-item flex items-center gap-3
                    px-3 py-2 text-base tracking-wider transition">
            <span class="ff7-cursor opacity-0">👉</span>
            <span><%= game.played_age %>歳</span>
          </a>
        <% end %>
      </div>
    </div>
  </aside>
</div>

<!-- ===== FF7モーダル ===== -->
<!-- ===== FF7 詳細モーダル ===== -->
<div id="game-modal"
     class="fixed inset-0 hidden items-center justify-center
            bg-black/70 backdrop-blur-sm z-50">

  <div
    class="ff7-detail-card ff7-window
           w-full max-w-2xl
           p-8 relative">

    <!-- タイトル -->
    <h2 id="modal-title"
        class="text-2xl font-bold tracking-widest text-blue-100 mb-2">
    </h2>

    <!-- メタ情報 -->
    <p id="modal-meta"
       class="text-sm tracking-wider text-blue-200/80 mb-6">
    </p>

    <!-- メモ本文 -->
    <div
      class="bg-black/30
             border border-blue-300/30
             rounded-md
             p-4 mb-8
             text-slate-200 leading-relaxed">
      <p id="modal-memo"></p>
    </div>

    <!-- FF7コマンド -->
    <div class="grid grid-cols-2 gap-6 text-center tracking-widest">
      <button class="ff7-command">へんしゅう</button>
      <button class="ff7-command text-red-300">さくじょ</button>
    </div>

    <!-- 閉じる -->
    <button onclick="closeModal()"
            class="absolute top-4 right-5
                   text-slate-400 hover:text-white">
      ✕
    </button>
  </div>
</div>


<!-- ===== JS ===== -->
<script>
  const gameModal = document.getElementById("game-modal")
  const modalTitle = document.getElementById("modal-title")
  const modalMeta  = document.getElementById("modal-meta")
  const modalMemo  = document.getElementById("modal-memo")

  function openModal(title, meta, memo) {
    modalTitle.innerText = title
    modalMeta.innerText = meta
    modalMemo.innerText = memo || "……"
    gameModal.classList.remove("hidden")
    gameModal.classList.add("flex")
  }

  function closeModal() {
    gameModal.classList.add("hidden")
    gameModal.classList.remove("flex")
  }

  document.addEventListener("DOMContentLoaded", () => {
    const ageItems = document.querySelectorAll(".ff7-age-item")
    const yearSections = document.querySelectorAll("[id^='year-']")

    function activateYear(year) {
      ageItems.forEach(item => {
        const active = item.dataset.year === year
        item.classList.toggle("active", active)
        item.querySelector(".ff7-cursor")
            .classList.toggle("opacity-0", !active)
      })
    }

    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          activateYear(entry.target.id.replace("year-", ""))
          entry.target.querySelector(".timeline-card")
            ?.classList.add("is-visible")
        }
      })
    }, { threshold: 0.6 })

    yearSections.forEach(section => observer.observe(section))
  })
</script>
